{% extends "base.html" %}

{% block titolo %}
Profilo Organizzatore
{% endblock %}

{% block contenuto %}
<div class="container">
  <h2 class="mb-4">Filtra Performances</h2>
  <!-- Filtri -->
  <form method="GET" class="mb-4">
    <div class="row g-3">
      <div class="col-md-4 col-12">
        <label class="form-label">Palco</label>
        <select name="palco" class="form-select">
          <option value="">Tutti</option>
          {% for palco in palchi %}
          <option value="{{ palco[0] }}" {% if filtro_palco==palco[0]|string %}selected{% endif %}>{{ palco[1] }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4 col-12">
        <label class="form-label">Data</label>
        <select name="data" class="form-select">
          <option value="">Tutte</option>
          {% for d in date %}
          <option value="{{ d.iso }}" {% if filtro_data==d.iso %}selected{% endif %}>{{ d.formattata }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4 col-12">
        <label class="form-label">Genere</label>
        <select name="genere" class="form-select">
          <option value="">Tutti</option>
          {% for g in generi %}
          <option value="{{ g }}" {% if filtro_genere==g %}selected{% endif %}>{{ g }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="mt-3 d-flex flex-wrap gap-2">
      <button class="btn btn-primary" type="submit">Applica Filtri</button>
      <a href="{{ url_for('profilo_organizzatore') }}" class="btn btn-secondary">Rimuovi Filtri</a>
    </div>
  </form>

  <div class="container">
    <div class="row">
      {% for perf in pubblicate %}
      <div class="col-md-6 col-12 mb-4">
        <article class="card h-100 position-relative">

          <!-- Link all'intera card -->
          <a href="{{ url_for('dettaglio_performance', id=perf[0]) }}"
            class="text-decoration-none text-dark stretched-link position-relative z-0">
            <div class="row g-0">
              <div class="col-md-3 col-4 d-flex align-items-center justify-content-center p-3">
                <img src="{{ url_for('static', filename=artisti[perf[0]][1]) }}" class="rounded-circle img-fluid"
                  style="width: 80px; height: 80px; object-fit: cover;" alt="Foto artista {{ artisti[perf[0]][1] }}">
              </div>
              <div class="col-md-9 col-8">
                <div class="card-body">
                  <h5 class="card-title">{{ perf[5] }}</h5>
                  <p class="card-text"><strong>Artista:</strong> {{ artisti[perf[0]][0] }}</p>
                  <p class="card-text"><strong>Data:</strong> {{ perf[1] }}</p>
                  <p class="card-text"><strong>Ora:</strong> {{ perf[2] }} - {{ perf[3] }}</p>
                  <p class="card-text">
                    <strong>Durata:</strong>
                    {{ (perf[3][:2]|int - perf[2][:2]|int) * 60 + (perf[3][3:5]|int - perf[2][3:5]|int) }} minuti
                  </p>
                  <p class="card-text"><strong>Descrizione:</strong> {{ perf[4] }}</p>
                  <p class="card-text"><strong>Genere:</strong> {{ perf[7] }}</p>
                  <p class="card-text"><strong>Palco:</strong> {{ perf[8] }}</p>
                </div>
              </div>
            </div>
          </a>

          {% if perf[9]|int == current_user.id %}
          <!-- Elimina bozza-->
          <div class="p-3">
            <form method="POST" action="{{ url_for('elimina_performance', id=perf[0]) }}">
              <button class="btn btn-danger btn-sm w-100 position-relative z-1" type="submit">Elimina</button>
            </form>
          </div>
          {% endif %}
        </article>
      </div>
      {% endfor %}
    </div>
  </div>



  <hr class="my-5">

  <!-- Sezione bozze performance -->
  <h2>Le tue bozze</h2>
  <div class="row">
    {% for bozza in bozze %}
    <article class="col-md-6 col-12 mb-4">
      <div class="card border-warning shadow-sm h-100">
        <div class="row g-0">
          <div class="col-md-3 col-4 d-flex align-items-center justify-content-center p-3">
            <img src="{{ url_for('static', filename=artisti[bozza[0]][1]) }}" class="rounded-circle img-fluid"
              style="width: 80px; height: 80px; object-fit: cover;" alt="Foto artista {{ artisti[bozza[0]][0] }}">
          </div>
          <div class="col-md-9 col-8">
            <div class="card-body">
              <h5 class="card-title">{{ bozza[5] }}</h5>
              <p class="card-text"><strong>Data:</strong> {{ bozza[1] }}</p>
              <p class="card-text"><strong>Ora:</strong> {{ bozza[2] }} - {{ bozza[3] }}</p>
              <p class="card-text"><strong>Durata:</strong> {{ (bozza[3][:2]|int - bozza[2][:2]|int) * 60 +
                (bozza[3][3:5]|int - bozza[2][3:5]|int) }} minuti</p>
              <p class="card-text"><strong>Descrizione:</strong> {{ bozza[4] }}</p>
              <p class="card-text"><strong>Genere:</strong> {{ bozza[7] }}</p>
              <p class="card-text"><strong>Palco:</strong> {{ bozza[8] }}</p>
              <div class="mt-3 d-flex flex-wrap gap-2">
                <button class="btn btn-warning btn-sm" data-bs-toggle="modal"
                  data-bs-target="#modalModificaBozza{{ bozza[0] }}">Modifica</button>
                <form method="POST" action="{{ url_for('elimina_performance', id=bozza[0]) }}" class="d-inline">
                  <button class="btn btn-danger btn-sm" type="submit">Elimina</button>
                </form>
                <form method="post" action="{{ url_for('pubblica_bozza', id=bozza[0]) }}" class="d-inline">
                  <button class="btn btn-success btn-sm" type="submit">Pubblica</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </article>
    {% endfor %}
  </div>

  <!-- Bottone nuova performance -->
  <div class="text-end my-4">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuovaPerformance">
      <i class="bi bi-plus-circle"></i> Nuova Performance
    </button>
  </div>

  <!-- MODAL: Form per aggiungere una nuova performance -->
  <div class="modal fade" id="modalNuovaPerformance" tabindex="-1" aria-labelledby="modalNuovaPerformanceLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form action="{{ url_for('nuova_performance') }}" method="POST" class="modal-content"
        enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title" id="modalNuovaPerformanceLabel">Aggiungi Performance</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">

          <div class="mb-2">
            <label for="data">Giorno</label>
            <select name="data" class="form-select" required>
              <option value="2025-06-20">Venerdì 20 Giugno</option>
              <option value="2025-06-21">Sabato 21 Giugno</option>
              <option value="2025-06-22">Domenica 22 Giugno</option>
            </select>
          </div>

          <div class="mb-2">
            <label>Ora inizio</label>
            <input type="time" name="ora_inizio" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Ora fine</label>
            <input type="time" name="ora_fine" class="form-control" required>
          </div>

          <div class="mb-2">
            <label>Nome artista</label>
            <input type="text" name="nome_artista" class="form-control" required>
          </div>

          <div class="mb-2">
            <label>Genere musicale</label>
            <input type="text" name="genere" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Descrizione</label>
            <textarea name="descrizione" class="form-control" required></textarea>
          </div>

          <div class="mb-2">
            <label>Palco</label>
            <select name="id_palco" class="form-select" required>
              {% for palco in palchi %}
              <option value="{{ palco[0] }}">{{ palco[1] }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-2">
            <label>Visibilità</label>
            <select name="visibilita" class="form-select" required>
              <option value="1">Pubblica</option>
              <option value="0">Bozza</option>
            </select>
          </div>

          <div class="mb-2">
            <label>Immagine artista</label>
            <input type="file" name="img_artista" accept="image/*" class="form-control" required>
          </div>

          {% for i in range(1, 6) %}
          <div class="mb-2">
            <label>Foto Opzionale {{ i }}</label>
            <input type="file" name="foto{{ i }}" accept="image/*" class="form-control">
          </div>
          {% endfor %}

        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Salva Performance</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL per modificare ogni singola bozza -->
  {% for bozza in bozze %}
  <div class="modal fade" id="modalModificaBozza{{ bozza[0] }}" tabindex="-1"
    aria-labelledby="modalModificaBozza{{ bozza[0] }}Label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form action="{{ url_for('modifica_bozza', id=bozza[0]) }}" method="POST" class="modal-content"
        enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title" id="modalModificaBozza{{ bozza[0] }}Label">Modifica Bozza: {{ bozza[5] }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">

          <div class="mb-2">
            <label for="data">Giorno</label>
            <select name="data" class="form-select" required>
              <option value="2025-06-20" {% if bozza[1]=='Venerdì 20 Giugno' %} selected{% endif %}>Venerdì
                20 Giugno</option>
              <option value="2025-06-21" {% if bozza[1]=='Sabato 21 Giugno' %}selected{% endif %}>Sabato 21 Giugno
              </option>
              <option value="2025-06-22" {% if bozza[1]=='Domenica 22 Giugno' %}selected{% endif %}>Domenica 22
                Giugno</option>
            </select>
          </div>

          <div class="mb-2">
            <label>Ora inizio</label>
            <input type="time" name="ora_inizio" class="form-control" value="{{ bozza[2] }}" required>
          </div>
          <div class="mb-2">
            <label>Ora fine</label>
            <input type="time" name="ora_fine" class="form-control" value="{{ bozza[3] }}" required>
          </div>

          <div class="mb-2">
            <label>Nome artista</label>
            <input type="text" name="nome_artista" class="form-control" value="{{ artisti[bozza[0]][0] }}" required>
          </div>

          <div class="mb-2">
            <label>Genere musicale</label>
            <input type="text" name="genere" class="form-control" value="{{ bozza[8] }}" required>
          </div>
          <div class="mb-2">
            <label>Descrizione</label>
            <textarea name="descrizione" class="form-control" required>{{ bozza[4] }}</textarea>
          </div>

          <div class="mb-2">
            <label>Palco</label>
            <select name="id_palco" class="form-select" required>
              {% for palco in palchi %}
              <option value="{{ palco[0] }}" {% if palco[0]==bozza[10] %}selected{% endif %}>{{ palco[1] }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-2">
            <div class="mb-2">
              <label>Immagine artista</label>
              <input type="file" name="img_artista" accept="image/jpg, image/png" class="form-control">
            </div>
            {% for i in range(1, 6) %}
            <div class="mb-2">
              <label>Foto Opzionale {{ i }}</label>
              <input type="file" name="foto{{ i }}" accept="image/jpg, image/png" class="form-control">
            </div>
            {% endfor %}
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Salva Modifiche</button>
          </div>
      </form>
    </div>
  </div>
  {% endfor %}
</div>

<h2 class="mb-4">Monitora vendite</h2>
<!-- NUOVO: Sezione Statistiche Disponibilità -->
{% if statistiche_disponibilita %}
<div class="card mb-4 badge-highlight text-white">
  <div class="card-body">
    <h6 class="card-title text-1">📊 Disponibilità Biglietti per Data</h6>
    <div class="row">
      {% for data, stats in statistiche_disponibilita.items() %}
      <div class="col-md-4 mb-2">
        <div class="card bg-light text-dark">
          <div class="card-body p-2">
            <small class="fw-bold">{{ data }}</small><br>
            <small>
              Disponibili: <span
                class="fw-bold {% if stats.disponibili < 50 %}text-1{% elif stats.disponibili < 100 %}text-warning{% else %}text-1{% endif %}">
                {{ stats.disponibili }}/{{ stats.totale }}
              </span>
            </small>
            <div class="progress mt-1" style="height: 8px;">
              <div
                class="progress-bar {% if stats.percentuale_venduta >= 90 %}bg-danger{% elif stats.percentuale_venduta >= 70 %}bg-warning{% else %}bg-success{% endif %}"
                style="width: {{ stats.percentuale_venduta }}%"></div>
            </div>
            <small class="text-muted">{{ stats.percentuale_venduta }}% venduti</small>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

</div>
{% endblock %}